# Chapter 6
## 云原生软件架构
### 软件架构面临的主要挑战
控制复杂性：由于业务的复杂性，需要我们用更好的手段帮助研发组织克服认知障碍，更好的分工协作。分而治之，关注点分离等手段皆是如此。

应对不确定性：业务在快速发展，需求在不断变化。即使再完美的软件架构，然而随着时间的推移，团队的变化，软件架构的调整不可避免。读《设计模式》，《微服务设计》等书字里行间写的都是“解耦”两字，让我们关注架构中确定性和不确定性的分离，提升架构的稳定性和应变能力。

管理系统性风险：管理系统中的确定性以及不确定性风险，规避已知陷阱，对未知的风险做好准备。

云原生应用架构的目标是：构建松耦合、具备弹性、韧性的分布式应用软件架构，可以更好地应对业务需求的变化和发展，保障系统稳定性

2012年，Heroku创始人Adam Wiggins发布了十二要素应用宣言，它为构建一个优雅的互联网应用，定义了需要遵循的一些基本原则和方法论，也广泛影响了众多的微服务应用架构。12 要素应用为我们提供了很好的架构指导，帮助我们：
1. 构建水平伸缩的弹性应用架构，更好支撑互联网规模应用。
2. 提升研发流程的标准化、自动化水平，提升研发效率。
3. 减少开发环境和生产环境的差异，并使用持续交付实施敏捷开发。
4. 提升应用的可移植性，适合云化部署，降低资源成本和管理复杂性

### 松耦合架构设计
微服务的核心理念：系统中的各个服务可被独立开发、独立部署，独立升级，各个服务之间是松耦合的。云原生应用架构理念是进一步强调架构的松耦合，降低服务之间相互依赖的程度。
![image](https://github.com/user-attachments/assets/07a86e54-aaac-4f1d-867f-8b09e094c633)

###  API优先的应用架构设计
在面向对象的软件架构中，最重要的是定义对象以及对象的接口契约。SOLID 原则是最被人广为熟知的设计原则：  
Single responsibility principle - 单一职责原则；  
Open/closed principle - 开放/封闭原则；  
Liskov substitution principle - 里氏替换原则；  
Interface segregation principle - 接口隔离原则；  
Dependency inversion principle - 依赖翻转原则  

API 应该是被优先设计的：用户的需求是复杂多变，然而业务逻辑和概念模型和服务交互是相对稳定的，API的接口是更加稳定的，而具体的API的实现是可以迭代和持续变化的，因此良好的API定义可以保障应用系统的质量

API应该是声明式，可描述/自描述的：所谓“声明式”，指的就是只需要提交一个定好的API对象来“声明”，我期待的状态是什么样子，并且把达到这个期望状态的所涉及的所有对象的参数都在声明中给出

API应该具备SLA

API必须是可以跨平台进行标准化交互的

#### 事件驱动架构（EDA-Event Driven Architecture）
事件是指对已经发生的事情、状态变化等的记录。它们是不可变的（无法更改或删除），并且按其创建顺序排序。相关各方可以通过订阅已发布的事件来获取有关这些状态变化的通知，然后使用所选择的业务逻辑根据这些信息采取操作。

事件驱动架构时一种构建松耦合的微服务系统的架构方式，微服务之间通过异步事件通信来进行交互

事件驱动架构实现了事件的生产者和消费者调用关系的彻底解耦。后续可以增加消息中间件对事件进行动态路由和转换，减少了生产者与消费者之间的时序上的依赖。

事件驱动架构提升了系统的可伸缩性，事件生产者在等待事件消费时不会被阻塞，可以采用Pub/Sub方式，让多个消费者并行处理事件

事件驱动架构可以与FaaS相整合，事件触发函数执行业务逻辑，在函数中也可以编写集成多个服务的“胶水代码”，简单且高效地构建事件驱动架构的应用由于 EDA 自身架构的优点，在互联网应用架构，业务数据化和智能化、IoT 等场景有非常广阔的前景

面相交付的应用架构
在云原生软件架构中，我们在设计阶段不只是关注软件如何被构建，也需要以终为始。关注如何合理设计和实现软件，才可以被更好地交付和运维
1. 应用和运行环境解耦
2. 自包含可观察性
3. 面向失败的设计

### 应用基础设施能力下沉
云原生软件架构的重要目标让开发者关注业务逻辑，让平台去承载系统复杂性。云原生计算重新定义了应用与应用基础设施的边界，进一步提升了开发效率，降低了分布式应用开发的复杂性。服务治理能力与业务逻辑解耦

### 新一代分布式应用运行时崛起的背景
分布式应用在开发运行时主要四类典型的需求：  
生命周期（Lifecycle）、网络（Networking）、状态（State）、捆绑（Binding）
![image](https://github.com/user-attachments/assets/ba98fcb7-7027-4501-8d2e-99c60139c0cd)
典型的JavaEE应用服务器的架构如下：  
应用生命周期由各种应用容器管理，如web容器，EJB容器等  
应用的安全管理、事务管理、连接池管理都是交给应用服务器完成的。应用可以通过JDBC、JMS等标准API接口访问外部的企业中间件，如数据库、消息队列等  
![image](https://github.com/user-attachments/assets/b7c65658-3a0b-4e23-a523-d520b69c09a1)

### 未来趋势
Dapr是一个事件驱动的，可移植的，构建微服务应用的运行时环境  
支持应用在云或边缘部署  
支持语言与框架的多样性  
利用Sidecar模式，把应用逻辑中的一些横切关注点需求（Cross-cutting）分离和抽象出来，从而达到应用与运行环境的解耦以及对外部依赖（包括服务之间）的解耦  

1. 底层是各类云平台或边缘环境
2. 中间是Dapr运行时和组件层，解耦外部服务和服务的消费者，可以按需加载。组件以统一的Http/gRPC API为应用层提供服务访问。Dapr运行时作为一个独立的sidecar进行，独立于应用逻辑
3. 应用通过轻量化的SDK来简化对组件API的调用，且基于gRPC/Http开放协议可以支持多语言

### 总结
#### 应用基础设施能力下沉
让开发者专注于业务逻辑，服务治理，依赖管理，弹性，运维等复杂性由系统实现  
服务网格将应用逻辑与服务治理解耦  
DAPR将应用逻辑与应用运行时系统能力架构  
Serverless让开发者无须关注运维  

#### 开放技术和标准化成为驱动力
减少厂商绑定，促进生态化发展  
开放技术促进了生态发展和提升可移植性  
标准化提升互操作性  
Kubernetes等事实标准，gRPC，OpenTelemetry等潜在标准成为云原生基石  

#### 运行时技术的敏捷进化
更轻、更快、更敏捷  
面向企业应用的Java，.Net敏捷进化，GraalVM等新兴虚拟机技术和Quarkus应用框架，将推动云原生应用架构发展  
WebAssembly有潜力成为新一代无处不在的云原生应用运行时  

#### 松耦合架构的深化
容错性好、易于管理和便于观察的松耦合系统  
应用与运行环境解耦  
应用与外部依赖解耦  
服务自包含，易于交付，自身具备可观察性













